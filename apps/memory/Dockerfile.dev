FROM oven/bun:1.3.4-debian

WORKDIR /app

# Copy package files for dependency installation
COPY package.json bun.lock ./
COPY patches ./patches
COPY turbo.json ./

# Copy all workspace package.json files
COPY apps/memory/package.json ./apps/memory/
COPY packages/events/package.json ./packages/events/
COPY packages/execution-core/package.json ./packages/execution-core/
COPY packages/infra/package.json ./packages/infra/
COPY packages/ingestion-core/package.json ./packages/ingestion-core/
COPY packages/logger/package.json ./packages/logger/
COPY packages/memory-core/package.json ./packages/memory-core/
COPY packages/search-core/package.json ./packages/search-core/
COPY packages/storage/package.json ./packages/storage/
COPY packages/tsconfig/package.json ./packages/tsconfig/
COPY packages/vfs/package.json ./packages/vfs/

# Install dependencies (no frozen-lockfile for partial workspace)
RUN bun install

# Copy source files
COPY packages ./packages
COPY apps/memory ./apps/memory

WORKDIR /app/apps/memory

CMD ["bun", "run", "src/index.ts"]
