{
	"dashboard": {
		"title": "Engram Reranker Performance",
		"tags": ["engram", "search", "reranker"],
		"timezone": "browser",
		"schemaVersion": 16,
		"version": 1,
		"refresh": "10s",
		"time": {
			"from": "now-1h",
			"to": "now"
		},
		"panels": [
			{
				"id": 1,
				"title": "Reranking Latency by Tier",
				"type": "graph",
				"gridPos": {
					"x": 0,
					"y": 0,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "histogram_quantile(0.50, sum(rate(engram_rerank_latency_seconds_bucket[5m])) by (tier, le))",
						"legendFormat": "{{tier}} - p50",
						"refId": "A"
					},
					{
						"expr": "histogram_quantile(0.95, sum(rate(engram_rerank_latency_seconds_bucket[5m])) by (tier, le))",
						"legendFormat": "{{tier}} - p95",
						"refId": "B"
					},
					{
						"expr": "histogram_quantile(0.99, sum(rate(engram_rerank_latency_seconds_bucket[5m])) by (tier, le))",
						"legendFormat": "{{tier}} - p99",
						"refId": "C"
					}
				],
				"yaxes": [
					{
						"format": "s",
						"label": "Latency"
					},
					{
						"format": "short"
					}
				],
				"xaxis": {
					"mode": "time"
				},
				"lines": true,
				"fill": 1,
				"linewidth": 2,
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"legend": {
					"show": true,
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"max": true,
					"min": true,
					"values": true
				}
			},
			{
				"id": 2,
				"title": "Cache Hit Rate",
				"type": "gauge",
				"gridPos": {
					"x": 12,
					"y": 0,
					"w": 6,
					"h": 8
				},
				"targets": [
					{
						"expr": "engram_embedding_cache_hit_rate",
						"legendFormat": "Embedding Cache",
						"refId": "A"
					},
					{
						"expr": "engram_query_cache_hit_rate",
						"legendFormat": "Query Cache",
						"refId": "B"
					}
				],
				"options": {
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"fieldConfig": {
					"defaults": {
						"min": 0,
						"max": 1,
						"unit": "percentunit",
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"value": 0,
									"color": "red"
								},
								{
									"value": 0.3,
									"color": "yellow"
								},
								{
									"value": 0.6,
									"color": "green"
								}
							]
						}
					}
				}
			},
			{
				"id": 3,
				"title": "Cache Statistics",
				"type": "stat",
				"gridPos": {
					"x": 18,
					"y": 0,
					"w": 6,
					"h": 8
				},
				"targets": [
					{
						"expr": "rate(engram_embedding_cache_hits_total[5m])",
						"legendFormat": "Embedding Hits/s",
						"refId": "A"
					},
					{
						"expr": "rate(engram_embedding_cache_misses_total[5m])",
						"legendFormat": "Embedding Misses/s",
						"refId": "B"
					},
					{
						"expr": "rate(engram_query_cache_hits_total[5m])",
						"legendFormat": "Query Hits/s",
						"refId": "C"
					},
					{
						"expr": "rate(engram_query_cache_misses_total[5m])",
						"legendFormat": "Query Misses/s",
						"refId": "D"
					}
				],
				"fieldConfig": {
					"defaults": {
						"unit": "ops"
					}
				}
			},
			{
				"id": 4,
				"title": "Score Improvement Distribution",
				"type": "graph",
				"gridPos": {
					"x": 0,
					"y": 8,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "engram_rerank_score_improvement{tier=\"fast\"}",
						"legendFormat": "Fast Tier",
						"refId": "A"
					},
					{
						"expr": "engram_rerank_score_improvement{tier=\"accurate\"}",
						"legendFormat": "Accurate Tier",
						"refId": "B"
					},
					{
						"expr": "engram_rerank_score_improvement{tier=\"code\"}",
						"legendFormat": "Code Tier",
						"refId": "C"
					},
					{
						"expr": "engram_rerank_score_improvement{tier=\"llm\"}",
						"legendFormat": "LLM Tier",
						"refId": "D"
					}
				],
				"yaxes": [
					{
						"format": "short",
						"label": "Score Improvement"
					},
					{
						"format": "short"
					}
				],
				"xaxis": {
					"mode": "time"
				},
				"lines": true,
				"fill": 2,
				"linewidth": 2,
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"legend": {
					"show": true,
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"max": true,
					"min": true,
					"values": true
				}
			},
			{
				"id": 5,
				"title": "Error Rates by Tier",
				"type": "graph",
				"gridPos": {
					"x": 12,
					"y": 8,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "rate(engram_rerank_requests_total{status=\"failure\"}[5m]) by (tier)",
						"legendFormat": "{{tier}} - Failures",
						"refId": "A"
					},
					{
						"expr": "rate(engram_rerank_requests_total{status=\"success\"}[5m]) by (tier)",
						"legendFormat": "{{tier}} - Success",
						"refId": "B"
					}
				],
				"yaxes": [
					{
						"format": "ops",
						"label": "Requests/sec"
					},
					{
						"format": "short"
					}
				],
				"xaxis": {
					"mode": "time"
				},
				"lines": true,
				"fill": 1,
				"linewidth": 2,
				"stack": false,
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"legend": {
					"show": true,
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"values": true
				}
			},
			{
				"id": 6,
				"title": "Throughput by Tier",
				"type": "graph",
				"gridPos": {
					"x": 0,
					"y": 16,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "rate(engram_rerank_requests_total[5m]) by (tier)",
						"legendFormat": "{{tier}}",
						"refId": "A"
					}
				],
				"yaxes": [
					{
						"format": "reqps",
						"label": "Requests/sec"
					},
					{
						"format": "short"
					}
				],
				"xaxis": {
					"mode": "time"
				},
				"lines": true,
				"fill": 1,
				"linewidth": 2,
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"legend": {
					"show": true,
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"max": true,
					"values": true
				}
			},
			{
				"id": 7,
				"title": "Candidate Count Distribution",
				"type": "heatmap",
				"gridPos": {
					"x": 12,
					"y": 16,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "sum(rate(engram_rerank_candidates_count_bucket[5m])) by (le)",
						"legendFormat": "{{le}}",
						"refId": "A",
						"format": "heatmap"
					}
				],
				"dataFormat": "tsbuckets",
				"hideZeroBuckets": true,
				"highlightCards": true,
				"tooltip": {
					"show": true,
					"showHistogram": true
				},
				"yAxis": {
					"format": "short",
					"label": "Candidate Count"
				},
				"xAxis": {
					"mode": "time"
				},
				"color": {
					"mode": "spectrum",
					"cardColor": "#b4ff00",
					"colorScale": "sqrt",
					"exponent": 0.5,
					"colorScheme": "interpolateOranges"
				}
			},
			{
				"id": 8,
				"title": "Model Load Status",
				"type": "table",
				"gridPos": {
					"x": 0,
					"y": 24,
					"w": 24,
					"h": 6
				},
				"targets": [
					{
						"expr": "count(engram_rerank_requests_total) by (tier, model)",
						"legendFormat": "{{tier}} - {{model}}",
						"refId": "A",
						"format": "table",
						"instant": true
					}
				],
				"transformations": [
					{
						"id": "organize",
						"options": {
							"excludeByName": {
								"Time": true,
								"Value": false
							},
							"indexByName": {},
							"renameByName": {
								"tier": "Tier",
								"model": "Model",
								"Value": "Request Count"
							}
						}
					}
				],
				"options": {
					"showHeader": true
				},
				"fieldConfig": {
					"defaults": {
						"custom": {
							"align": "left",
							"displayMode": "auto"
						}
					},
					"overrides": []
				}
			},
			{
				"id": 9,
				"title": "Cache Memory Usage",
				"type": "graph",
				"gridPos": {
					"x": 0,
					"y": 30,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "engram_embedding_cache_size_bytes",
						"legendFormat": "Embedding Cache Size",
						"refId": "A"
					},
					{
						"expr": "engram_embedding_cache_entries_count",
						"legendFormat": "Embedding Cache Entries",
						"refId": "B"
					}
				],
				"yaxes": [
					{
						"format": "bytes",
						"label": "Cache Size"
					},
					{
						"format": "short",
						"label": "Entry Count"
					}
				],
				"xaxis": {
					"mode": "time"
				},
				"lines": true,
				"fill": 1,
				"linewidth": 2,
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"legend": {
					"show": true,
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"max": true,
					"values": true
				}
			},
			{
				"id": 10,
				"title": "Cache Eviction Rate",
				"type": "graph",
				"gridPos": {
					"x": 12,
					"y": 30,
					"w": 12,
					"h": 8
				},
				"targets": [
					{
						"expr": "rate(engram_embedding_cache_evictions_total[5m])",
						"legendFormat": "Evictions/sec",
						"refId": "A"
					}
				],
				"yaxes": [
					{
						"format": "ops",
						"label": "Evictions/sec"
					},
					{
						"format": "short"
					}
				],
				"xaxis": {
					"mode": "time"
				},
				"lines": true,
				"fill": 1,
				"linewidth": 2,
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"legend": {
					"show": true,
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"max": true,
					"values": true
				},
				"alert": {
					"conditions": [
						{
							"evaluator": {
								"params": [0.5],
								"type": "gt"
							},
							"operator": {
								"type": "and"
							},
							"query": {
								"params": ["A", "5m", "now"]
							},
							"reducer": {
								"params": [],
								"type": "avg"
							},
							"type": "query"
						}
					],
					"executionErrorState": "alerting",
					"for": "5m",
					"frequency": "1m",
					"handler": 1,
					"name": "High Cache Eviction Rate",
					"noDataState": "no_data",
					"notifications": []
				}
			}
		],
		"templating": {
			"list": [
				{
					"name": "tier",
					"type": "query",
					"datasource": "Prometheus",
					"query": "label_values(engram_rerank_requests_total, tier)",
					"refresh": 1,
					"multi": true,
					"includeAll": true,
					"allValue": ".*"
				},
				{
					"name": "interval",
					"type": "interval",
					"query": "1m,5m,10m,30m,1h",
					"auto": true,
					"auto_count": 30,
					"auto_min": "10s"
				}
			]
		},
		"annotations": {
			"list": [
				{
					"datasource": "Prometheus",
					"enable": true,
					"expr": "changes(engram_rerank_requests_total[1m]) > 100",
					"iconColor": "rgba(255, 96, 96, 1)",
					"name": "High Request Rate",
					"titleFormat": "Request Spike"
				}
			]
		}
	},
	"overwrite": true
}
